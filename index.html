<html>
<body>

<canvas id="shapesCanvas" width="300" height="400"></canvas>
<canvas id="c" width="100" height="100"></canvas>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<!--
<script type="text/javascript">
//http://jsfiddle.net/paul/XQpzU/2/light/
// requestAnim shim layer by Paul Irish
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       || 
          window.webkitRequestAnimationFrame || 
          window.mozRequestAnimationFrame    || 
          window.oRequestAnimationFrame      || 
          window.msRequestAnimationFrame     || 
          function(/* function */ callback, /* DOMElement */ element){
            window.setTimeout(callback, 1000 / 60);
          };
})();
// example code from mr doob : http://mrdoob.com/lab/javascript/requestanimationframe/
var canvas, context;
init();
animate();
function init() {
    //canvas = document.createElement( 'canvas' );
    canvas = document.getElementById('c');
    context = canvas.getContext('2d');
    canvas.width = 256;
    canvas.height = 256;
    //context = canvas.getContext( '2d' );
    //document.body.appendChild( canvas );
}

function animate() {
    requestAnimFrame( animate );
    draw();
}
function draw() {
    var time = new Date().getTime() * 0.002;
    var x = Math.sin( time ) * 96 + 128;
    var y = Math.cos( time * 0.9 ) * 96 + 128;
    context.fillStyle = 'rgb(245,245,245)';
    context.fillRect( 0, 0, 255, 255 );
    context.fillStyle = 'rgb(255,0,0)';
    context.beginPath();
    context.arc( x, y, 10, 0, Math.PI * 2, true );
    context.closePath();
    context.fill();
}
</script>
-->

<script type="text/javascript">


function KeyData(){
    this.keyDownU = false;
    this.keyDownD = false;
    this.keyDownL = false;
    this.keyDownR = false;
}


function Shape(ix,iy){
    this.x=ix;
    this.y=iy;
    this.w=10;
    this.h=10;
    this.v=1;
    this.a=270;
    this.backgroundColor = "white";
    this.borderColor = "black";
}
Shape.prototype.collide = function(shape){
    //http://www.gamedev.net/page/resources/_/technical/game-programming/collision-detection-r735
    var offset = 1;
    var l1 = this.x + offset;
    var l2 = shape.x + offset;
    var r1 = l1 + this.w;
    var r2 = l2 + shape.w;
    
    var t1 = this.y + offset;
    var t2 = shape.y + offset;
    var b1 = t1 + this.h;
    var b2 = t2 + shape.h;
    
    if(b1 < t2) return false;
    if(t1 > b2) return false;
    if(r1 < l2) return false;
    if(l1 > r2) return false;
    return true;
}
Shape.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    c.strokeStyle = this.borderColor;
    c.lineWidth = 1;
    c.fillRect(this.x, this.y, this.w, this.h);
    c.strokeRect(this.x, this.y, this.w, this.h);
}

//
// CLASS: Engine
//
function Engine(c,w,h){
    this.score = 0;
    this.frame = 0;
    this.context = c;
    this.canvasW = w;
    this.canvasH = h;
    this.keyData = new KeyData();
    this.player = new Shape(0,0);
    this.testShape = new Shape(0,0);
    this.shapeArray = new Array();
    this.isGameOver = false;
    this.engineLoop;
}
Engine.prototype.advanceFrame = function(){
    this.frame++;
    //move player
    if(this.keyData.keyDownU && this.player.y > 1){
        this.player.y -= 5;
    }
    if(this.keyData.keyDownD && this.player.y < this.canvasH-5){
        this.player.y += 5;
    }
    if(this.keyData.keyDownL && this.player.x > 1){
        this.player.x -= 5;
    }
    if(this.keyData.keyDownR && this.player.x < this.canvasW-5){
        this.player.x += 5;
    }
    
    if(this.testShape.y < this.canvasH + 1){
        this.testShape.y += this.testShape.v;
    }else{
        this.initTestShape();
    }
    
    if(this.player.collide(this.testShape)){
        this.isGameOver = true;
    }
}
Engine.prototype.initTestShape = function(){
    this.testShape = new Shape(Math.round(Math.random()*this.canvasW + 20) - 10, -10);
    //this.testShape.v = Math.round(Math.random()*10);
    this.testShape.v = 4;
}

//Reset the engine to starting conditions
Engine.prototype.init = function(){
    this.isGameOver = false;
    this.frame = 0;
    this.player.x = Math.round(this.canvasW/2);
    this.player.y = Math.round(this.canvasH/2);
    this.player.backgroundColor = "#0f0";
    this.player.borderColor = "#000";
    this.initTestShape();
    if(typeof this.engineLoop != "undefined"){
        clearInterval(this.engineLoop);
    }
    var engineRef = this;
    this.engineLoop = setInterval(function(){engineRef.engineAdvance()}, 30);
}


Engine.prototype.engineAdvance = function run() {
    if(this.isGameOver){
        this.context.fillStyle = "#fff";
        this.context.fillRect(0, 0, this.canvasW, this.canvasH);
        this.context.strokeStyle = "black";
        this.context.strokeRect(0, 0, this.canvasW, this.canvasH);
        this.player.backgroundColor = "#f00";
    }else{
        this.advanceFrame();
        this.context.fillStyle = "#eee";
        this.context.fillRect(0, 0, this.canvasW, this.canvasH);
        this.context.strokeStyle = "black";
        this.context.strokeRect(0, 0, this.canvasW, this.canvasH);
    }
    this.testShape.draw(this.context);
    this.player.draw(this.context);
    var text = "FRAME: " + this.frame
        + " "
        + (this.keyData.keyDownU ? "U" : "")
        + (this.keyData.keyDownD ? "D" : "")
        + (this.keyData.keyDownL ? "L" : "")
        + (this.keyData.keyDownR ? "R" : "");
    this.context.fillText(text, 5, this.canvasH-5);
}






$(document).ready(function(){
	//Canvas stuff
	var canvas = $("#shapesCanvas")[0];
	var context = canvas.getContext("2d");
	var w = $("#shapesCanvas").width();
	var h = $("#shapesCanvas").height();
    var engine;
    
    engine = new Engine(context,w,h);
	engine.init();
	
	//Lets add the keyboard controls now
	$(document).keydown(function(e){
		var key = e.which;
		if(key == "37") {
            engine.keyData.keyDownL = true;
        } else if(key == "38") {
            engine.keyData.keyDownU = true;
        } else if(key == "39") {
            engine.keyData.keyDownR = true;
        } else if(key == "40") {
            engine.keyData.keyDownD = true;
        }
	})
	$(document).keyup(function(e){
        switch(e.which){
            case keycode_spacebar:
                engine.init();
                break;
        }
		var key = e.which;
		if(key == "37") {
            engine.keyData.keyDownL = false;
        } else if(key == "38") {
            engine.keyData.keyDownU = false;
        } else if(key == "39") {
            engine.keyData.keyDownR = false;
        } else if(key == "40") {
            engine.keyData.keyDownD = false;
        }
	})
	
	var keycode_spacebar = 32;
	
})

</script>


</body>
</html>
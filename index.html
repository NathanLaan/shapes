<html>
<body>

<canvas id="shapesCanvas" width="300" height="400"></canvas>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">


//namespace
Shapes = {};

extend = function(subClass, baseClass) {
   function inheritance() {}
   inheritance.prototype = baseClass.prototype;
   subClass.prototype = new inheritance();
   subClass.prototype.constructor = subClass;
   subClass.baseConstructor = baseClass;
   subClass.superClass = baseClass.prototype;
}



function KeyData(){
    this.keyDownU = false;
    this.keyDownD = false;
    this.keyDownL = false;
    this.keyDownR = false;
}


function Shape(ix,iy){
    this.x=ix;
    this.y=iy;
    this.w=8;
    this.h=8;
    this.v=1;
    this.a=270;
    this.backgroundColor = "#888";
    this.borderColor = "black";
    this.collideOffset = 2;
}
Shape.prototype.collide = function(shape){
    //http://www.gamedev.net/page/resources/_/technical/game-programming/collision-detection-r735
    var l1 = this.x + this.collideOffset;
    var l2 = shape.x + this.collideOffset;
    var r1 = l1 + this.w - 2*this.collideOffset;
    var r2 = l2 + shape.w - 2*this.collideOffset;
    
    var t1 = this.y + this.collideOffset;
    var t2 = shape.y + this.collideOffset;
    var b1 = t1 + this.h - 2*this.collideOffset;
    var b2 = t2 + shape.h - 2*this.collideOffset;
    
    if(b1 < t2) return false;
    if(t1 > b2) return false;
    if(r1 < l2) return false;
    if(l1 > r2) return false;
    return true;
}
Shape.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    //c.strokeStyle = this.borderColor;
    //c.lineWidth = 1;
    //c.fillRect(this.x, this.y, this.w, this.h);
    //c.strokeRect(this.x, this.y, this.w, this.h);

    //circle
    c.beginPath();
    c.arc(this.x + this.w/2, this.y + this.h/2, this.w/2, 0, 360);
    c.closePath();
    c.fill();
}

extend(Player,Shape);
function Player(x,y){
    Player.baseConstructor.call(this, x, y);
    this.isInvincible = false;
    this.invincibleCounter = 0; //100?
}
Player.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    c.strokeStyle = this.borderColor;
    c.lineWidth = 1;

    c.beginPath();
    c.moveTo(this.x, this.y + this.h);
    c.lineTo(this.x + (this.w/2), this.y);
    c.lineTo(this.x + this.w, this.y + this.h);
    c.lineTo(this.x, this.y + this.h);
    c.fill();
    c.stroke();
    c.closePath();
}



extend(Square,Shape);
function Square(x,y){
    Square.baseConstructor.call(this, x, y);
    this.backgroundColor = "#0ff";
    this.w = 14;
    this.h = 14;
    this.collideOffset = 0;
    //
    // TODO: "Freeze" blocks?
    //
    this.isFrozen = false;
    this.isBlackHoled = false;
}
Square.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    //c.strokeStyle = this.borderColor;
    //c.lineWidth = 1;
    c.fillRect(this.x, this.y, this.w, this.h);
    //c.strokeRect(this.x, this.y, this.w, this.h);
}


extend(Hole,Shape);
function Hole(x,y){
    Hole.baseConstructor.call(this, x, y);
    this.backgroundColor = "#000";
    this.w = 14;
    this.h = 14;
    this.collideOffset = 0;
}
Hole.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    c.fillRect(this.x, this.y, this.w, this.h);
}



//
// CLASS: Engine
//
function Engine(c,w,h){
    this.score = 0;
    this.frame = 0;
    this.context = c;
    this.canvasW = w;
    this.canvasH = h;
    this.keyData = new KeyData();
    this.player = new Player(0,0);
    this.player.w = 12;
    this.player.h = 16;
    this.shapeArray = new Array();
    this.squareArray = new Array();
    this.blackHoleArray = new Array();
    this.isRunning = false;
    this.isGameOver = false;
    this.engineLoop;
    this.newShapeFrequency = 100;
}

Engine.prototype.gameLoop = function() {
    if(this.isGameOver){
        this.context.fillStyle = "#fff";
        this.context.fillRect(0, 0, this.canvasW, this.canvasH);
        this.context.strokeStyle = "black";
        this.context.strokeRect(0, 0, this.canvasW, this.canvasH);
        this.player.backgroundColor = "#f00";

        this.stopEngine();
        this.context.fillStyle = "#e00";
        this.context.font = "26px Helvetica";
        this.context.fillText("GAME OVER :(", 5, 30);
        //
        // TODO: draw "GAME OVER" text
        //
        // TODO: draw "Hit ENTER to start a new game" text
        //
    }else{
        this.frame++;
        //move player
        var moveAmount = 4;
        if(this.keyData.keyDownU && this.player.y > 1){
            this.player.y -= moveAmount;
        }
        if(this.keyData.keyDownD && this.player.y < this.canvasH-moveAmount){
            this.player.y += moveAmount;
        }
        if(this.keyData.keyDownL && this.player.x > 1){
            this.player.x -= moveAmount;
        }
        if(this.keyData.keyDownR && this.player.x < this.canvasW-moveAmount){
            this.player.x += moveAmount;
        }

        var randFreq = Math.round(Math.random() * this.newShapeFrequency);
        if(this.frame % randFreq < 1){
            //console.log("RAND: " + randFreq);
            this.addShape();
        }

        if(this.frame % this.newShapeFrequency < 2){
            // for(var i=0;i<(this.getDifficulty());i++){
            //     this.addShape();
            // }
            this.addShape();
            if(this.newShapeFrequency > 1){

                //
                // randomly decrease
                //
                var randCheck = Math.random() * 10;
                if(randCheck < 5){
                    this.newShapeFrequency--;
                }
            }
        }

        for(var i=0; i<this.shapeArray.length;i++){
            var s = this.shapeArray[i];    
            if(s.y < this.canvasH + 1){
                s.y += s.v;
            }else{
                this.shapeArray.splice(i,1);
            }
            if(this.player.collide(s)){
                this.isGameOver = true;
            }
        }

        var blackHoled = false;

        for(var i=0; i<this.blackHoleArray.length;i++){
            var s = this.blackHoleArray[i];    
            if(s.y < this.canvasH + 1){
                s.y += s.v;
            }else{
                this.blackHoleArray.splice(i,1);
            }
            if(s.collide(this.player)){
                blackHoled = true;
            }
        }

        for(var i=0; i<this.squareArray.length;i++){
            var s = this.squareArray[i];
            if(blackHoled){
                s.isBlackHoled = true;
                s.backgroundColor = "#ff0";
            }
            if(this.player.collide(s)){
                this.score++;
                this.squareArray.splice(i,1);
                if(this.isBlackHoled){
                    console.log("HOLED!");
                }
            }
            if(s.isFrozen){
                //TODO: move to player
            }else{
                if(s.y < this.canvasH + 1){
                    s.y += s.v;
                }else{
                    this.squareArray.splice(i,1);
                }
            } 
        }

        this.context.fillStyle = "#eee";
        this.context.fillRect(0, 0, this.canvasW, this.canvasH);
        this.context.strokeStyle = "black";
        this.context.strokeRect(0, 0, this.canvasW, this.canvasH);
    }

    for(var i=0;i<this.blackHoleArray.length;i++){
        var s = this.blackHoleArray[i];    
        s.draw(this.context);
    }
    for(var i=0;i<this.squareArray.length;i++){
        var s = this.squareArray[i];    
        s.draw(this.context);
    }
    for(var i=0;i<this.shapeArray.length;i++){
        var s = this.shapeArray[i];    
        s.draw(this.context);
    }
    this.player.draw(this.context);
    var text = "SCORE: " + this.score
        + " FRAME: " + this.frame;
        // + (" FREQ: " + this.newShapeFrequency)
        // + (" DIFF: " + this.getDifficulty())
        // + " "
        // + (this.keyData.keyDownU ? "U" : "")
        // + (this.keyData.keyDownD ? "D" : "")
        // + (this.keyData.keyDownL ? "L" : "")
        // + (this.keyData.keyDownR ? "R" : "");
    this.context.font = "12px Helvetica";
    this.context.fillText(text, 5, this.canvasH-5);

}

Engine.prototype.getDifficulty = function(){
    return this.frame / this.newShapeFrequency / 4;
}

Engine.prototype.addShape = function(){
    //var s = new Shape(Math.round(Math.random()*this.canvasW + 10), -10);
    //
    // TEMP: Give us a "safe spot" along the top edge of the canvas
    //
    var s = new Shape(Math.round(Math.random()*this.canvasW + 2), +20);
    //s.v = (Math.random()* this.getDifficulty()) + 1;
    //
    // Fixed random velocity:
    //
    s.v = (Math.random()* 3) + 1;
    this.shapeArray.push(s);

    this.addSquare();
    this.addBlackHole();
}

Engine.prototype.addSquare = function(){
    //var s = new Shape(Math.round(Math.random()*this.canvasW + 10), -10);
    //
    // TEMP: Give us a "safe spot" along the top edge of the canvas
    //
    var s = new Square(Math.round(Math.random()*this.canvasW + 10), +20);
    //s.v = (Math.random()* this.getDifficulty()) + 1;
    //
    // Fixed random velocity:
    //
    s.v = (Math.random()* 3) + 1;
    this.squareArray.push(s);
}

Engine.prototype.addBlackHole = function(){
    //var s = new Shape(Math.round(Math.random()*this.canvasW + 10), -10);
    //
    // TEMP: Give us a "safe spot" along the top edge of the canvas
    //
    var s = new Hole(Math.round(Math.random()*this.canvasW + 10), +20);
    //s.v = (Math.random()* this.getDifficulty()) + 1;
    //
    // Fixed random velocity:
    //
    s.v = (Math.random()* 3) + 1;
    this.blackHoleArray.push(s);
}

//Reset the engine to starting conditions
Engine.prototype.init = function(){
    this.isGameOver = false;
    this.frame = 0;
    this.player.x = Math.round(this.canvasW/2);
    this.player.y = Math.round(this.canvasH/2);
    this.player.backgroundColor = "#0f0";
    this.player.borderColor = "#000";
    this.shapeArray.length = 0;
    this.squareArray.length = 0;
    this.blackHoleArray.length = 0;
    this.newShapeFrequency = 100;
    this.addShape();
    this.startEngine();
    this.isRunning = true;
}

Engine.prototype.playPause = function(){
    if(this.isRunning){
        this.stopEngine();
        this.context.fillStyle = "#00e";
        this.context.font = "26px Helvetica";
        this.context.fillText("PAUSED", 5, 30);

        //
        // Good spot for some debug info!
        //
        console.log( "SHAPES: " + this.shapeArray.length
        + " FRAME: " + this.frame
        + " FREQ: " + this.newShapeFrequency
        + " DIFF: " + this.getDifficulty()
        + " "
        + (this.keyData.keyDownU ? "U" : "")
        + (this.keyData.keyDownD ? "D" : "")
        + (this.keyData.keyDownL ? "L" : "")
        + (this.keyData.keyDownR ? "R" : ""));
    }else{
        this.startEngine();
    }
    this.isRunning = !this.isRunning;
}

Engine.prototype.startEngine = function(){
    if(typeof this.engineLoop != "undefined"){
        this.stopEngine();
    }
    var engineRef = this;
    this.engineLoop = setInterval(function(){engineRef.gameLoop()}, 30);
}
Engine.prototype.stopEngine = function(){
    clearInterval(this.engineLoop);
}




$(document).ready(function(){
	var canvas = $("#shapesCanvas")[0];
	var context = canvas.getContext("2d");
	var w = $("#shapesCanvas").width();
	var h = $("#shapesCanvas").height();
    var engine;
    
    engine = new Engine(context,w,h);
	engine.init();
	
    //
    // http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
    //
	var kc_space = 32;
    var kc_w = 87;
    var kc_a = 65;
    var kc_s = 83;
    var kc_d = 68;
    var kc_up = 38;
    var kc_down = 40;
    var kc_left = 37;
    var kc_right = 39;
    var kc_enter = 13;
	
	$(document).keydown(function(e){
        switch(e.which){
            case kc_w:
            case kc_up:
                engine.keyData.keyDownU = true;
                break;
            case kc_s:
            case kc_down:
                engine.keyData.keyDownD = true;
                break;
            case kc_a:
            case kc_left:
                engine.keyData.keyDownL = true;
                break;
            case kc_d:
            case kc_right:
                engine.keyData.keyDownR = true;
                break;
        }
	})
    
	$(document).keyup(function(e){
        switch(e.which){
            case kc_space:
                if(!engine.isGameOver){
                    engine.playPause();
                }
                break;
            case kc_enter:
                engine.init();
                break;
            case kc_w:
            case kc_up:
                engine.keyData.keyDownU = false;
                break;
            case kc_s:
            case kc_down:
                engine.keyData.keyDownD = false;
                break;
            case kc_a:
            case kc_left:
                engine.keyData.keyDownL = false;
                break;
            case kc_d:
            case kc_right:
                engine.keyData.keyDownR = false;
                break;
        }
	})
	
})

</script>


</body>
</html>
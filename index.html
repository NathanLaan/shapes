<html>
<body>

<canvas id="shapesCanvas" width="300" height="400"></canvas>
<canvas id="c" width="100" height="100"></canvas>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<!--
<script type="text/javascript">
//http://jsfiddle.net/paul/XQpzU/2/light/
// requestAnim shim layer by Paul Irish
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       || 
          window.webkitRequestAnimationFrame || 
          window.mozRequestAnimationFrame    || 
          window.oRequestAnimationFrame      || 
          window.msRequestAnimationFrame     || 
          function(/* function */ callback, /* DOMElement */ element){
            window.setTimeout(callback, 1000 / 60);
          };
})();
// example code from mr doob : http://mrdoob.com/lab/javascript/requestanimationframe/
var canvas, context;
init();
animate();
function init() {
    //canvas = document.createElement( 'canvas' );
    canvas = document.getElementById('c');
    context = canvas.getContext('2d');
    canvas.width = 256;
    canvas.height = 256;
    //context = canvas.getContext( '2d' );
    //document.body.appendChild( canvas );
}

function animate() {
    requestAnimFrame( animate );
    draw();
}
function draw() {
    var time = new Date().getTime() * 0.002;
    var x = Math.sin( time ) * 96 + 128;
    var y = Math.cos( time * 0.9 ) * 96 + 128;
    context.fillStyle = 'rgb(245,245,245)';
    context.fillRect( 0, 0, 255, 255 );
    context.fillStyle = 'rgb(255,0,0)';
    context.beginPath();
    context.arc( x, y, 10, 0, Math.PI * 2, true );
    context.closePath();
    context.fill();
}
</script>
-->

<script type="text/javascript">


//namespace
NL = {};

extend = function(subClass, baseClass) {
   function inheritance() {}
   inheritance.prototype = baseClass.prototype;
   subClass.prototype = new inheritance();
   subClass.prototype.constructor = subClass;
   subClass.baseConstructor = baseClass;
   subClass.superClass = baseClass.prototype;
}



function KeyData(){
    this.keyDownU = false;
    this.keyDownD = false;
    this.keyDownL = false;
    this.keyDownR = false;
}


function Shape(ix,iy){
    this.x=ix;
    this.y=iy;
    this.w=10;
    this.h=10;
    this.v=1;
    this.a=270;
    this.backgroundColor = "white";
    this.borderColor = "black";
}
Shape.prototype.collide = function(shape){
    //http://www.gamedev.net/page/resources/_/technical/game-programming/collision-detection-r735
    var offset = 1;
    var l1 = this.x + offset;
    var l2 = shape.x + offset;
    var r1 = l1 + this.w;
    var r2 = l2 + shape.w;
    
    var t1 = this.y + offset;
    var t2 = shape.y + offset;
    var b1 = t1 + this.h;
    var b2 = t2 + shape.h;
    
    if(b1 < t2) return false;
    if(t1 > b2) return false;
    if(r1 < l2) return false;
    if(l1 > r2) return false;
    return true;
}
Shape.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    c.strokeStyle = this.borderColor;
    c.lineWidth = 1;
    c.fillRect(this.x, this.y, this.w, this.h);
    c.strokeRect(this.x, this.y, this.w, this.h);
}

function Player(ix,iy){
    Player.baseConstructor.call(this, ix, iy);
}
extend(Player,Shape);
Player.prototype.draw = function(c){
    c.fillStyle = this.backgroundColor;
    c.strokeStyle = this.borderColor;
    c.lineWidth = 1;

    c.beginPath();
    c.moveTo(this.x, this.y + this.h);
    c.lineTo(this.x + (this.w/2), this.y);
    c.lineTo(this.x + this.w, this.y + this.h);
    c.lineTo(this.x, this.y + this.h);
    c.fill();
    c.stroke();
    c.closePath();
}

//
// CLASS: Engine
//
function Engine(c,w,h){
    this.score = 0;
    this.frame = 0;
    this.context = c;
    this.canvasW = w;
    this.canvasH = h;
    this.keyData = new KeyData();
    this.player = new Player(0,0);
    this.shapeArray = new Array();
    this.isRunning = false;
    this.isGameOver = false;
    this.engineLoop;
    this.newShapeFrequency = 100;
}

Engine.prototype.gameLoop = function() {
    if(this.isGameOver){
        this.context.fillStyle = "#fff";
        this.context.fillRect(0, 0, this.canvasW, this.canvasH);
        this.context.strokeStyle = "black";
        this.context.strokeRect(0, 0, this.canvasW, this.canvasH);
        this.player.backgroundColor = "#f00";

        this.stopEngine();
        this.context.fillStyle = "#e00";
        this.context.font = "26px Helvetica";
        this.context.fillText("GAME OVER :(", 5, 30);
        //
        // TODO: draw "GAME OVER" text
        //
        // TODO: draw "Hit ENTER to start a new game" text
        //
    }else{
        this.frame++;
        //move player
        if(this.keyData.keyDownU && this.player.y > 1){
            this.player.y -= 5;
        }
        if(this.keyData.keyDownD && this.player.y < this.canvasH-5){
            this.player.y += 5;
        }
        if(this.keyData.keyDownL && this.player.x > 1){
            this.player.x -= 5;
        }
        if(this.keyData.keyDownR && this.player.x < this.canvasW-5){
            this.player.x += 5;
        }

        if(this.frame % this.newShapeFrequency < 2){
            for(var i=0;i<(this.getDifficulty());i++){
                this.addShape();
            }
            if(this.newShapeFrequency > 1){
                this.newShapeFrequency--;
            }
        }

        for(var i=0; i<this.shapeArray.length;i++){
            var s = this.shapeArray[i];    
            if(s.y < this.canvasH + 1){
                s.y += s.v;
            }else{
                this.shapeArray.splice(i,1);
            }
            if(this.player.collide(s)){
                this.isGameOver = true;
            }
        }
        this.context.fillStyle = "#eee";
        this.context.fillRect(0, 0, this.canvasW, this.canvasH);
        this.context.strokeStyle = "black";
        this.context.strokeRect(0, 0, this.canvasW, this.canvasH);
    }

    for(var i=0;i<this.shapeArray.length;i++){
        var s = this.shapeArray[i];    
        s.draw(this.context);
    }
    this.player.draw(this.context);
    var text = "FRAME: " + this.frame
        + (" FREQ: " + this.newShapeFrequency)
        + (" DIFF: " + this.getDifficulty())
        + " "
        + (this.keyData.keyDownU ? "U" : "")
        + (this.keyData.keyDownD ? "D" : "")
        + (this.keyData.keyDownL ? "L" : "")
        + (this.keyData.keyDownR ? "R" : "");
    this.context.font = "10px Helvetica";
    this.context.fillText(text, 5, this.canvasH-5);

}

Engine.prototype.getDifficulty = function(){
    return this.frame / this.newShapeFrequency / 4;
}

Engine.prototype.addShape = function(){
    //var s = new Shape(Math.round(Math.random()*this.canvasW + 10), -10);
    //
    // TEMP: Give us a "safe spot" along the left edge of the canvas
    //
    var s = new Shape(Math.round(Math.random()*this.canvasW + 30), -10);
    s.v = (Math.random()* this.getDifficulty()) + 1;
    this.shapeArray.push(s);
}

//Reset the engine to starting conditions
Engine.prototype.init = function(){
    this.isGameOver = false;
    this.frame = 0;
    this.player.x = Math.round(this.canvasW/2);
    this.player.y = Math.round(this.canvasH/2);
    this.player.backgroundColor = "#0f0";
    this.player.borderColor = "#000";
    this.shapeArray.length = 0;
    this.newShapeFrequency = 100;
    this.addShape();
    this.startEngine();
    this.isRunning = true;
}

Engine.prototype.playPause = function(){
    //
    // TODO: Check for this.isRunning
    //
    if(this.isRunning){
        this.stopEngine();
        this.context.fillStyle = "#00e";
        this.context.font = "26px Helvetica";
        this.context.fillText("PAUSED", 5, 30);

        //
        // Good spot for some debug info!
        //
        console.log( "SHAPES: " + this.shapeArray.length
        + " FRAME: " + this.frame
        + " FREQ: " + this.newShapeFrequency
        + " DIFF: " + this.getDifficulty()
        + " "
        + (this.keyData.keyDownU ? "U" : "")
        + (this.keyData.keyDownD ? "D" : "")
        + (this.keyData.keyDownL ? "L" : "")
        + (this.keyData.keyDownR ? "R" : ""));
    }else{
        this.startEngine();
    }
    this.isRunning = !this.isRunning;
}

Engine.prototype.startEngine = function(){
    if(typeof this.engineLoop != "undefined"){
        this.stopEngine();
    }
    var engineRef = this;
    this.engineLoop = setInterval(function(){engineRef.gameLoop()}, 30);
}
Engine.prototype.stopEngine = function(){
    clearInterval(this.engineLoop);
}




$(document).ready(function(){
	var canvas = $("#shapesCanvas")[0];
	var context = canvas.getContext("2d");
	var w = $("#shapesCanvas").width();
	var h = $("#shapesCanvas").height();
    var engine;
    
    engine = new Engine(context,w,h);
	engine.init();
	
    //
    // http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
    //
	var kc_space = 32;
    var kc_w = 87;
    var kc_a = 65;
    var kc_s = 83;
    var kc_d = 68;
    var kc_up = 38;
    var kc_down = 40;
    var kc_left = 37;
    var kc_right = 39;
    var kc_enter = 13;
	
	$(document).keydown(function(e){
        switch(e.which){
            case kc_w:
            case kc_up:
                engine.keyData.keyDownU = true;
                break;
            case kc_s:
            case kc_down:
                engine.keyData.keyDownD = true;
                break;
            case kc_a:
            case kc_left:
                engine.keyData.keyDownL = true;
                break;
            case kc_d:
            case kc_right:
                engine.keyData.keyDownR = true;
                break;
        }
	})
    
	$(document).keyup(function(e){
        switch(e.which){
            case kc_space:
                if(!engine.isGameOver){
                    engine.playPause();
                }
                break;
            case kc_enter:
                engine.init();
                break;
            case kc_w:
            case kc_up:
                engine.keyData.keyDownU = false;
                break;
            case kc_s:
            case kc_down:
                engine.keyData.keyDownD = false;
                break;
            case kc_a:
            case kc_left:
                engine.keyData.keyDownL = false;
                break;
            case kc_d:
            case kc_right:
                engine.keyData.keyDownR = false;
                break;
        }
	})
	
})

</script>


</body>
</html>